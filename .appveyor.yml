environment:
  matrix:
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
      PSEdition: Core
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
      PSEdition: Desktop
    - APPVEYOR_BUILD_WORKER_IMAGE: WMF 4
      PSEdition: Desktop

skip_branch_with_pr: true
build: off

test_script:
  - ps: |
      if ( $env:PSEdition -eq 'Desktop' ) {
      Set-StrictMode -Version Latest
      $env:CI = 1
      $r = Get-ChildItem *.ts.ps1 -Recurse | foreach { & $_.FullName -PassThru } ; if ([bool]($r | Where-Object { $_.Failed -gt 0 })) { exit 1 }
      $global:PesterDebugPreference = @{ ShowFullErrors = $true }
      Import-Module ./Pester.psd1
      Invoke-Pester -ExcludeTag VersionChecks, StyleRules, Help -ExcludePath '*/demo/*', '*/examples/*', '*/Gherkin*' -CI | Out-Null
      (New-Object 'System.Net.WebClient').UploadFile("https://ci.appveyor.com/api/testresults/nunit/${env:APPVEYOR_JOB_ID}", (Join-Path $PWD 'TestResults.xml')) }
  - pwsh: |
      if ( $env:PSEdition -eq 'Core' ) {
      Set-StrictMode -Version Latest
      $ErrorActionPreference = 'Stop'
      $env:CI = 1
      $r = Get-ChildItem *.ts.ps1 -Recurse | foreach { & $_.FullName -PassThru } ; if ([bool]($r | Where-Object { $_.Failed -gt 0 })) { exit 1 }
      $global:PesterDebugPreference = @{ ShowFullErrors = $true }
      Import-Module ./Pester.psd1
      Invoke-Pester -ExcludeTag VersionChecks, StyleRules, Help -ExcludePath '*/demo/*', '*/examples/*', '*/Gherkin*' -CI | Out-Null
      (New-Object 'System.Net.WebClient').UploadFile("https://ci.appveyor.com/api/testresults/nunit/${env:APPVEYOR_JOB_ID}", (Join-Path $PWD 'TestResults.xml')) }
